
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>抽奖</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
        }
        body {
            padding: 0;
            margin: 0;
        }
        canvas {
            width: 100%;
            height: 100%;
            background-color: #FFFFFF;
        }
        .wheel-pointer {
            position: absolute;
            left: 50%;
            top: 50%;
            margin-top: -23px;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <img class="wheel-pointer" id="wheel" src="./images//wheel-pointer.png" alt="wheel-pointer" />
    <script>

        // ***** 动画 function
        function Count (startVal, endVal, duration, callback) {
            this.timer = null;
            this.isStart = false;
            this.isPause = false;
            this.originStartVal = this.startVal = Number(startVal);
            this.originEndVal = this.endVal = Number(endVal);
            this.originDuration = this.duration = Number(duration) || 3000;
            if (!this.constructor.ensureNumber(this.startVal) ||
                !this.constructor.ensureNumber(this.endVal) ||
                !this.constructor.ensureNumber(this.duration)
            ) {
                console.error(`[Count] startVal (${startVal}) or endVal (${endVal}) or duration (${duration}) is not a number`);
            }
            this.callback = callback || function () {};
            this.countDown = this.startVal > this.endVal;
        }

        Count.ensureNumber = function (val) {
            return !isNaN(val) && typeof val === 'number';
        };

        Count.easeOutExpo = function (t, b, c, d) {
            return -c * ((t = t / d - 1) * t * t * t - 1) + b;
        }

        Count.prototype = {
            constructor: Count,
            count: function (timestamp) {
                if (!this.startTime) this.startTime = timestamp;
                var progress = timestamp - this.startTime;
                this.remaining = this.duration - progress;
                var val = this.countDown
                    ? this.startVal - this.constructor.easeOutExpo(progress, 0, this.startVal - this.endVal, this.duration)
                    : this.constructor.easeOutExpo(progress, this.startVal, this.endVal - this.startVal, this.duration);
                this.frameVal = this.countDown
                                    ? Math.max(val, this.endVal)
                                    : Math.min(val, this.endVal);
                if (progress < this.duration) {
                    this.timer = window.requestAnimationFrame(this.count.bind(this));
                } else {
                    this.isStart = false;
                    delete this.startTime;
                }
                this.callback(this.frameVal, !this.isStart);
            },
            start: function () {
                if (this.isStart) return;
                this.isStart = true;
                this.timer = window.requestAnimationFrame(this.count.bind(this));
            },
            update: function (newEndVal) {
                newEndVal = Number(newEndVal);
                if (!this.constructor.ensureNumber(newEndVal)) {
                    console.error('[CountUp] update() - new endVal is not a number: ' + newEndVal);
                    return;
                }
                if (newEndVal === this.frameVal) return;
                if (this.timer) {
                    window.cancelAnimationFrame(this.timer);
                    this.timer = null;
                }
                delete this.startTime;
                this.endVal = newEndVal;
                this.startVal = this.frameVal;
                this.duration = this.remaining;
                this.countDown = this.startVal > this.endVal;
                this.timer = window.requestAnimationFrame(this.count.bind(this));
            },
            reset: function () {
                this.timer = null;
                this.isStart = false;
                this.isPause = false;
                this.startVal = this.originStartVal;
                this.endVal = this.originEndVal;
                this.duration = this.originDuration;
                this.countDown = this.startVal > this.endVal;
            },
            resume: function () {
                if (this.isStart || !this.isPause) return;
                this.isPause = false;
                this.timer = window.requestAnimationFrame(this.count.bind(this));
            },
            pause: function () {
                if (!this.isStart || this.isPause) return;
                this.isPause = true;
                if (this.timer) {
                    window.cancelAnimationFrame(this.timer);
                    this.timer = null;
                }
            }
        };

        // ***** function
        function Lottery (el, options) {
            this.$ctx = el.getContext('2d');
            var rect = el.getBoundingClientRect();
            this._centerToCanvasX = rect.width / 2 + rect.left;
            this._centerToCanvasY = rect.height / 2 + rect.top;
            el.width = rect.width;
            el.height = rect.height;
            this._init(0);
        };

        Lottery.prototype = {
            constructor: Lottery,
            _init: function (n) {
                this.$ctx.clearRect(0, 0, this.$ctx.canvas.width, this.$ctx.canvas.height);
                this.$ctx.save();
                this.$ctx.translate(this.$ctx.canvas.width / 2, this.$ctx.canvas.height / 2);
                this.$ctx.rotate(15 * Math.PI / 180);
                this._baseOutCircle();
                this._baseMarquee();
                this._drawPlate(n);
                this._clickDrawCicle();
                this.$ctx.restore();
            },
            // 抽奖外圆
            _baseOutCircle: function () {
                this.$ctx.beginPath();
                this.$ctx.save();
                this.$ctx.fillStyle = '#FFBE04';
                this.$ctx.arc(0, 0, this.$ctx.canvas.height / 4, 0, Math.PI * 2, false);
                this.$ctx.fill();
                this.$ctx.restore();
            },
            // 跑马灯
            _baseMarquee: function () {
                for (var i = 0; i < 24; i++) {
                    this.$ctx.beginPath();
                    this.$ctx.save();
                    this.$ctx.rotate(i * 15 * Math.PI / 180);
                    this.$ctx.fillStyle = '#FFFFFF';
                    if (i % 2 === 0) {
                        this.$ctx.fillStyle = '#F00';
                    }
                    this.$ctx.arc(this.$ctx.canvas.height / 4 - 10, 0, 4, Math.PI * 2, false);
                    this.$ctx.fill();
                    this.$ctx.restore();
                }
            },
            // 抽奖盘
            _drawPlate (n) {
                this.$ctx.rotate(n * Math.PI / 180);
                for (var i = 0; i < 12; i++) {
                    this.$ctx.beginPath();
                    this.$ctx.save();
                    this.$ctx.rotate(i * 30 * Math.PI / 180);
                    this.$ctx.fillStyle = '#FFFFFF';
                    if (i % 2 === 0) {
                        this.$ctx.fillStyle = '#FFF4D6';
                    }

                    // 三角形
                    this.$ctx.beginPath();
                    this.$ctx.moveTo(0, 0);
                    this.$ctx.lineTo(this.$ctx.canvas.height / 4 - 20, 0);
                    this.$ctx.lineTo(Math.cos(30 * Math.PI / 180) * (this.$ctx.canvas.height / 4 - 20), Math.sin(30 * Math.PI / 180) * (this.$ctx.canvas.height / 4 - 20));
                    this.$ctx.fill();

                    // 绘制文字
                    this.$ctx.beginPath();
                    this.$ctx.save();
                    this.$ctx.translate(Math.cos(15 * Math.PI / 180) * (this.$ctx.canvas.height / 4 - 60), Math.sin(15 * Math.PI / 180) * (this.$ctx.canvas.height / 4 - 60));
                    this.$ctx.rotate(105 * Math.PI / 180);
                    this.$ctx.fillStyle = '#000000';
                    this.$ctx.font = "20px Georgia";
                    this.$ctx.textAlign = 'center';
                    this.$ctx.textBaseline = 'middle';
                    this.$ctx.fillText('200M', 0, 0);
                    this.$ctx.restore();

                    // 绘制文字
                    this.$ctx.beginPath();
                    this.$ctx.save();
                    this.$ctx.translate(Math.cos(15 * Math.PI / 180) * (this.$ctx.canvas.height / 4 - 90), Math.sin(15 * Math.PI / 180) * (this.$ctx.canvas.height / 4 - 90));
                    this.$ctx.rotate(105 * Math.PI / 180);
                    this.$ctx.fillStyle = '#000000';
                    this.$ctx.font = "20px Georgia";
                    this.$ctx.textAlign = 'center';
                    this.$ctx.textBaseline = 'middle';
                    this.$ctx.fillText('200M', 0, 0);
                    this.$ctx.restore();

                    // 弧形
                    this.$ctx.beginPath();
                    this.$ctx.arc(0, 0, this.$ctx.canvas.height / 4 - 20, 0, Math.PI / 6, false);
                    this.$ctx.fill();
                    this.$ctx.restore();
                }
            },
            _clickDrawCicle () {
                this.$ctx.beginPath();
                this.$ctx.fillStyle = '#FFBE04';
                this.$ctx.arc(0, 0, this.$ctx.canvas.height / 14, 0, Math.PI * 2, false);
                this.$ctx.fill();
            },
            destroy () {}
        };




    </script>
    <script>
        var wheel = document.getElementById('wheel');
        var lottery = new Lottery(document.getElementById('canvas'));

        var count = new Count(0, 360, 8000, function (val, status) {
            lottery._init(val * 5);
            if (status) {
                lottery._init(0);
            }
        });
        wheel.onclick = function () {
            count.start();
        };
    </script>
</body>
</html>
